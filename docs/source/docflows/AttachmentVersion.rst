Форматы документов
==================

Формат № 820
------------

Формат №820, утвержденный `Приказом ФНС России от 19.12.2018 № ММВ-7-15/820@ <https://normativ.kontur.ru/document?moduleId=1&documentId=328588&cwi=517>`__, пришел на смену формату №155 и распространяется на типы документов:

- *счета-фактуры*,
- *накладные, акты и другие первичные документы*,
- *УПД*.


.. rubric:: Работа в Диадоке

Для Диадока документ в формате №820 – это контейнер, внутри которого лежит информация о сделке, совершенной клиентом.

Диадок ничего не знает о том, как выглядит учетная политика клиентов, и, соответственно, не может угадать дали ему *ЭСФ/АКТ/Накладную/УПД*.

Более того, по содержанию документа так же нельзя однозначно отличить один тип документа от другого.

.. note::
    При отправке документа участник ЭДО всегда сам выбирает показатель «тип документа».

.. rubric:: Пример

Если продавец выставит счет-фактуру по формату согласно Приказу №820, укажет в документе функцию СЧФ, но тип документа в API укажет *UniversalTransferDocument*, то Диадок визуализирует документ, как УПД.

Чтобы визуализация счета-фактуры была привычной, при отправке документа необходимо указывать тип в API *Invoice*.

.. rubric:: Генерация и парсинг

Для генерации и парсинга документов в формате №820 можно следует только методы:
`GenerateSenderTitleXml <http://api-docs.diadoc.ru/ru/latest/http/GenerateSenderTitleXml.html>`_ и `GenerateRecipientTitleXml <http://api-docs.diadoc.ru/ru/latest/http/GenerateRecipientTitleXml.html>`_ для генерации,
`ParseTitleXml <http://api-docs.diadoc.ru/ru/latest/http/ParseTitleXml.html>`_ для парсинга


.. csv-table:: Соответствие типов документов и форматов документов
   :header: "Веб", "API", "Форматы", "Функция", "Печатная форма"
   :widths: 10, 10, 10, 10, 10

   "СФ", "Invoice", "- приказ №93 (устарел)

   - приказ №155 (устарел)
   - приказ №820", "- –
   - СЧФ
   - СЧФ", "СФ"
   "Исправление СФ", "InvoiceRevision", "- приказ №93 (устарел)

   - приказ №155 (устарел)
   - приказ №820", "- –
   - СЧФ
   - СЧФ", "СФ"
   "КСФ", "InvoiceCorrection", "- приказ №93 (устарел)

   - приказ №189 (устарел)
   - приказ 736", "- –
   - КСЧФ", "КСФ"
   "Накладная", "XmlTorg12", "- приказ №172 (устарел)

   - приказ №155 (устарел)
   - приказ №820
   - приказ №551", "- –
   - ДОП
   - ДОП
   - –", "Накладная"
   "Акт", "XmlAcceptanceCertificate", "- приказ №172 (устарел)

   - приказ №155 (устарел)
   - приказ №820
   - приказ №552", "- –
   - ДОП
   - ДОП
   - –", "Акт"
   "УПД", "UniversalTransferDocument", "- приказ №155 (устарел)
   
   - приказ №820", "- СЧФ
   - ДОП
   - СЧФДОП", "УПД"
   "Исправление УПД", "UniversalTransferDocument Revision", "- приказ №155 (устарел)
   
   - приказ №820", "- СЧФ
   - ДОП
   - СЧФДОП", "УПД"
   "УКД", "UniversalCorrectionDocument", "- приказ №189 (устарел)
   
   - приказ №736", "- КСЧФ
   - ДИС
   - КСЧФДИС", "УКД"


Возможные форматы
-----------------

В связи с тем, что документ может быть в разных форматах – интеграционным решениям необходимо понимать в каком формате пришел документ, что бы корректно обработать его на своей стороне.

Для получения акутальной информации о XSD-схеме документа введено специальное поле *Version*. Оно есть в структурах данных :doc:`Document <../proto/Document>`, :doc:`Entity <../proto/Entity message>` и :doc:`DocumentInfo <../proto/DocumentInfo>`.

.. note::
    Ниже приведен неполный список версий документов. Актуальные версии документа следует получать с помощью метода :doc:`GetDocumentTypes <../http/GetDocumentTypes>`

.. csv-table:: Примеры типов и значений Version для формализованных документов
   :header: "Тип документы", "Структура", "Возможные версии"
   :widths: 10, 10, 10

   "Счет-фактура (СФ)", "Invoice", "Приказ №93 (устарел)
   
   - invoice_05_01_01
   - invoice_05_01_03
   - invoice_05_02_01
   
   Приказ №155 (устарел)
   
   - utd_05_01_01
   - utd_05_01_02
   - utd_05_01_04
   - utd_05_01_05
   - utd_05_02_01
   
   Приказ №820
   
   - utd820_05_01_01
   - utd820_05_01_01_Hyphen"
   "Исправление СФ", "InvoiceRevision", "Приказ №93 (устарел)
   
   - invoice_05_01_03
   - invoice_05_02_01
   
   Приказ №155 (устарел)
   
   - utd_05_01_01
   - utd_05_01_02
   - utd_05_01_04
   - utd_05_01_05
   - utd_05_02_01
   
   Приказ №820
   
   - utd820_05_01_01
   - utd820_05_01_01_Hyphen"
   "Корректировочный СФ (КСФ)", "InvoiceCorrection", "Приказ №93 (устарел)
   
   - invoicecor_05_01_03
   - invoicecor_05_02_01
   
   Приказ № 189 (устарел)
   
   - ucd_05_01_01
   - ucd_05_01_02
   - ucd_05_02_01
   
   Приказ №736
   
   - ucd736_05_01_01
   - ucd736_05_01_02"
   "Исправление КСФ", "InvoiceCorrectionRevision", "Приказ № 93 (устарел)
   
   - invoicecor_05_01_03
   - invoicecor_05_02_01
   
   Приказ №189 (устарел)
   
   - ucd_05_01_01
   - ucd_05_01_02
   - ucd_05_02_01
   
   Приказ №736
   
   - ucd736_05_01_01
   - ucd736_05_01_02"
   "Формализованный ТОРГ-12", "XmlTorg12", "Приказ №172 (устарел)
   
   - torg12_05_01_01
   - torg12_05_01_02
   
   Приказ №155 (устарел)
   
   - utd_05_01_01
   - utd_05_01_02
   - utd_05_01_04
   - utd_05_01_05
   - utd_05_02_01
   
   Приказ №820
   
   - utd820_05_01_01
   - utd820_05_01_01_Hyphen
   
   Приказ № 551
   
   - tovtorg_05_01_02
   - tovtorg_05_01_03
   - tovtorg_05_02_01"
   "Формализованный акт", "XmlAcceptanceCertificate", "Приказ №172 (устарел)
   
   - act_05_01_01
   - act_05_01_02
   
   Приказ №155 (устарел)
   
   - utd_05_01_01
   - utd_05_01_02
   - utd_05_01_04
   - utd_05_01_05
   - utd_05_02_01
   
   Приказ №820
   
   - utd820_05_01_01
   - utd820_05_01_01_Hyphen
   
   Приказ №552
   
   - rezru_05_01_01
   - rezru_05_02_01"
   "УПД", "UniversalTransferDocument", "Приказ № 155 (устарел)
   
   - utd_05_01_01
   - utd_05_01_02
   - utd_05_01_04
   - utd_05_01_05
   - utd_05_02_01
   
   Приказ №820
   
   - utd820_05_01_01
   - utd820_05_01_01_Hyphen"
   "Исправление УПД", "UniversalTransferDocumentRevision", "Приказ №155 (устарел)
   
   - utd_05_01_01
   - utd_05_01_02
   - utd_05_01_04
   - utd_05_01_05
   - utd_05_02_01
   
   Приказ №820
   
   - utd820_05_01_01
   - utd820_05_01_01_Hyphen"
   "УКД", "UniversalCorrectionDocument", "Приказ №189 (устарел)
   
   - ucd_05_01_01
   - ucd_05_01_02
   - ucd_05_02_01
   
   Приказ №736
   
   - ucd736_05_01_01
   - ucd736_05_01_02"
   "Исправление УКД", "UniversalCorrectionDocumentRevision", "Приказ №189 (устарел)
   
   - ucd_05_01_01
   - ucd_05_01_02
   - ucd_05_02_01
   
   Приказ №736
   
   - ucd736_05_01_01
   - ucd736_05_01_02"

.. important::
  ``AttachmentVersion = UniversalTrnsaferDocument`` для СФ/ИСФ и ``AttachmentVersion = UniversalCorrectionDocument`` для КСФ/ИКСФ считаются устаревшими. Поле AttachmentVersion устарело. Вместо него используйте Version.

.. csv-table:: Типы и значения Version для неформализованных документов
    :header: "Тип документы", "Структура", "Возможные версии"
    :widths: 10, 10, 10

    "Неформализованный документ", "Nonformalized", "v1"
    "Приглашение к ЭДО", "TrustConnectionRequest", "v1"
    "Неформализованный ТОРГ-12", "Torg12", "v1"
    "Неформализованный акт", "AcceptanceCertificate", "v1"
    "Счет", "ProformaInvoice", "v1"
    "Ценовой лист", "PriceList", "v1"
    "Протокол согласования цены", "PriceListAgreement", "v1"
    "Реестр сертификатов", "CertificateRegistry", "v1"
    "Акт сверки", "ReconciliationAct", "v1"
    "Договор", "Contract", "v1"
    "Накладная", "Torg13", "v1"
    "Детализация", "ServiceDetails", "v1"
    "Доп. соглашение", "SupplementaryAgreement", "v1"

.. rubric:: Добавление новых версий

При обновление форматов формализованных документов ФНС, в Диадоке будут добавляться новые значения *Version*, соответствующие новым версиям формата.

Интеграционным решениям нужно быть готовыми к тому, что может прийти новое значение *Version*. Рекомендуется уметь обрабатывать такие ситуации.
