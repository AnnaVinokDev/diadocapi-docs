ShelfUpload
===========

Метод ``ShelfUpload`` предназначен для загрузки фрагмента документа на сервер «полки документов».

.. http:post:: /ShelfUpload

	:queryparam nameOnShelf: имя файла на «полке документов».
	:queryparam partIndex: номер загружаемого фрагмента файла. Фрагменты индексируются, начиная с 0.
	:queryparam isLastPart: признак того, что загружается последний фрагмент файла. Принимает значение 1 для последнего фрагмента. Для остальных фрагментов может отсутствовать или принимать значение 0.

	:requestheader Authorization: данные, необходимые для :doc:`авторизации <../Authorization>`.

	:statuscode 200: операция успешно завершена.
	:statuscode 400: данные в запросе имеют неверный формат или отсутствуют обязательные параметры.
	:statuscode 403: доступ к ящику с предоставленным авторизационным токеном запрещен.
	:statuscode 500: при обработке запроса возникла непредвиденная ошибка.

Для выполнения метода текущий пользователь должен быть авторизован в Диадоке, иначе метод вернет ошибку ``403 (Forbidden)``.

.. note:: Нельзя загрузить на «полку» файл весом больше 400 Мб.

Предполагается, что бинарные данные документа будут разделены на блоки, затем каждый блок будет загружен на «полку документов» с помощью отдельного вызова метода ``ShelfUpload``. 

Если вызвать метод ``ShelfUpload`` с параметром ``isLastPart = 1``, это будет значить, что файл (по мнению клиента) загружен полностью. В ответ сервис сообщит, были ли все фрагменты файла переданы успешно, или требуется повторная передача некоторых фрагментов. Если файл загружен полностью, он будет доступен для чтения с «полки документов». Имя загруженного файла можно указать в поле ``NameOnShelf`` структуры :doc:`../proto/SignedContent`.

Если в процессе загрузки были ошибки, и отдельные фрагменты файла отсутствуют, то вызов метода ``ShelfUpload`` с параметром ``isLastPart = 1``, вернет в теле ответа список номеров отсутствующих фрагментов файла в формате JSON. Эти фрагменты нужно передать еще раз.

.. note:: Все пространство логических имен файлов на «полке документов» поделено на локальное для пользователя и публичное.

По умолчанию, если вызвать метод ``ShelfUpload`` с параметром ``nameOnShelf = xyz``, то физическое имя файла будет публичным: ``public/xyz``. К таким файлам можно получить доступ через :doc:`ShelfDownload`, указав ``nameOnShelf = xyz``.

Если вызвать ``ShelfUpload`` с параметром ``nameOnShel f= __userId__/xyz``, где ``__userId__`` — это строковый литерал, то физическое имя файла будет ``user_private_files/{userId}/xyz``. ``{userId}`` возьмется из текущего авторизационного токена. К таким файлам можно получить доступ через :doc:`ShelfDownload`, указав ``nameOnShelf = __userId__/xyz``.

Методы :doc:`PostMessage` и :doc:`PostMessagePatch` трактуют переданное имя файла как локальное для пользователя, поэтому дописывают вначале префикс ``user_private_files/{userId}``.

Загруженный с помощью метода ``ShelfUpload`` файл будет хранится на «полке» 30 дней.